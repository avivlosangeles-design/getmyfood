<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GET My .FOOD</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .title-text { font-size: 1.7rem; font-weight: 700; color: #ff0000; }
    .food-banner {
      background-image: url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=1600&q=80');
      background-size: cover; background-position: center; height: 300px;
    }
    .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #map { height: 300px; width: 100%; margin-top: 20px; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <div class="food-banner rounded-lg mb-8 flex items-center justify-center">
      <h1 class="title-text bg-white bg-opacity-80 px-6 py-4 rounded-lg">
        What kind of food would you like to eat today?
      </h1>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-bold mb-4 text-primary">Find Your Perfect Meal</h2>
      <form id="searchForm" class="space-y-4">
        <div>
          <label for="foodType" class="block text-sm font-medium text-gray-700">Food Type</label>
          <input type="text" id="foodType" placeholder="e.g. vegetarian, pizza" 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
        </div>
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
          <input type="text" id="location" placeholder="Zip code or city" 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
        </div>
        <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-red-700 transition flex justify-center">
          <span id="searchText">Search</span>
          <div id="searchSpinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-5 w-5 ml-2 hidden"></div>
        </button>
      </form>
    </div>

    <div id="map" class="hidden"></div>
    <div id="results" class="space-y-6"></div>

    <div id="pagination" class="flex justify-center mt-8 hidden">
      <button id="prevBtn" class="px-4 py-2 bg-secondary text-white rounded-l-md hover:bg-blue-700 disabled:bg-gray-300">Previous</button>
      <span id="pageInfo" class="px-4 py-2 bg-gray-100">Page 1 of 1</span>
      <button id="nextBtn" class="px-4 py-2 bg-secondary text-white rounded-r-md hover:bg-blue-700 disabled:bg-gray-300">Next</button>
    </div>

    <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden" role="alert">
      <span class="block sm:inline" id="errorText"></span>
    </div>
  </div>

  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <script>
    const AZURE_MAPS_KEY = (() => {
  // Try getting from Netlify environment variables first
  if (typeof process !== 'undefined' && process.env.AZURE_MAPS_KEY) {
    return process.env.AZURE_MAPS_KEY;
  }
  // Fallback to empty string (will show error)
  return '';
})();

if (!AZURE_MAPS_KEY) {
  document.getElementById('errorText').textContent = 
    'Azure Maps key not configured. Please set AZURE_MAPS_KEY environment variable in Netlify.';
  document.getElementById('errorMessage').classList.remove('hidden');
}
    let currentPage = 1, totalPages = 1, lastSearchTerm = '', lastLocation = '';
    let map, popup, datasource;

    const searchForm = document.getElementById('searchForm');
    const resultsContainer = document.getElementById('results');
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const searchSpinner = document.getElementById('searchSpinner');
    const searchText = document.getElementById('searchText');
    const mapContainer = document.getElementById('map');

    function initMap() {
      map = new atlas.Map('map', { authOptions: { authType: 'subscriptionKey', subscriptionKey: AZURE_MAPS_KEY } });
      map.controls.add([new atlas.control.ZoomControl(), new atlas.control.CompassControl()], { position: 'top-right' });
      popup = new atlas.Popup();
      datasource = new atlas.source.DataSource();
      map.sources.add(datasource);
      map.layers.add(new atlas.layer.SymbolLayer(datasource));
    }

    searchForm.addEventListener('submit', handleSearch);
    prevBtn.addEventListener('click', goToPreviousPage);
    nextBtn.addEventListener('click', goToNextPage);

    window.addEventListener('DOMContentLoaded', () => {
      if (AZURE_MAPS_KEY && AZURE_MAPS_KEY !== '<%= process.env.AZURE_MAPS_KEY %>') {
        initMap();
      } else {
        showError('Azure Maps key not configured. Please set AZURE_MAPS_KEY environment variable.');
      }
    });

    async function handleSearch(e) {
      e.preventDefault();
      const foodType = document.getElementById('foodType').value.trim();
      const location = document.getElementById('location').value.trim();

      if (!foodType || !location) {
        showError('Please enter both food type and location');
        return;
      }

      searchText.textContent = 'Searching...';
      searchSpinner.classList.remove('hidden');
      errorMessage.classList.add('hidden');

      try {
        lastSearchTerm = foodType;
        lastLocation = location;
        currentPage = 1;
        await searchRestaurants(foodType, location, currentPage);
      } catch (error) {
        showError('Failed to fetch restaurants. Please try again later.');
      } finally {
        searchText.textContent = 'Search';
        searchSpinner.classList.add('hidden');
      }
    }

    async function searchRestaurants(term, location, page = 1) {
      const offset = (page - 1) * 10;
      try {
        const geocodeUrl = `https://atlas.microsoft.com/search/address/json?api-version=1.0&query=${encodeURIComponent(location)}&subscription-key=${AZURE_MAPS_KEY}`;
        const geocodeResponse = await fetch(geocodeUrl);
        if (!geocodeResponse.ok) throw new Error(`Geocoding failed with status ${geocodeResponse.status}`);
        const geocodeData = await geocodeResponse.json();
        if (!geocodeData.results || geocodeData.results.length === 0) throw new Error('Location not found');
        const { lat, lon } = geocodeData.results[0].position;
        
        const searchUrl = `https://atlas.microsoft.com/search/poi/json?api-version=1.0&query=${encodeURIComponent(term)}&lat=${lat}&lon=${lon}&radius=5000&limit=10&offset=${offset}&subscription-key=${AZURE_MAPS_KEY}`;
        const searchResponse = await fetch(searchUrl);
        if (!searchResponse.ok) throw new Error(`Search failed with status ${searchResponse.status}`);
        
        const searchData = await searchResponse.json();
        totalPages = Math.ceil(searchData.totalResults / 10);
        mapContainer.classList.remove('hidden');
        displayResults(searchData.results);
        updatePagination();
        updateMap(searchData.results, lat, lon);
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }

    function displayResults(restaurants) {
      resultsContainer.innerHTML = '';
      if (!restaurants || restaurants.length === 0) {
        showError('No restaurants found. Try a different search.');
        return;
      }

      restaurants.forEach(restaurant => {
        const address = restaurant.address || {};
        const streetAddress = address.streetNumber ? `${address.streetNumber} ${address.streetName}` : address.streetName || '';
        const fullAddress = [streetAddress, address.municipality, address.countrySubdivision, address.postalCode].filter(part => part).join(', ');
        
        const card = document.createElement('div');
        card.className = 'restaurant-card bg-white p-6 rounded-lg shadow-md';
        card.innerHTML = `
          <h3 class="text-lg font-bold text-secondary mb-2">${restaurant.poi ? restaurant.poi.name : 'Unnamed Restaurant'}</h3>
          <div class="flex items-center text-sm text-gray-600 mb-2">
            <span>${fullAddress || 'Address not available'}</span>
            ${restaurant.phone ? `<span class="mx-2">â€¢</span><span>${restaurant.phone}</span>` : ''}
          </div>
          <div class="menu-item bg-gray-50 p-4 rounded-md mt-3">
            <h4 class="font-medium text-accent">${lastSearchTerm} Options Available</h4>
            <p class="text-sm text-gray-700">Check their menu for ${lastSearchTerm} options</p>
            ${restaurant.url ? `<a href="${restaurant.url}" target="_blank" class="text-sm text-primary hover:underline">View Details</a>` : ''}
          </div>
        `;
        resultsContainer.appendChild(card);
      });
    }

    function updateMap(restaurants, centerLat, centerLon) {
      datasource.clear();
      datasource.add(new atlas.data.Feature(new atlas.data.Point([centerLon, centerLat]), { type: 'center' }));
      restaurants.forEach(restaurant => {
        if (restaurant.position) {
          datasource.add(new atlas.data.Feature(
            new atlas.data.Point([restaurant.position.lon, restaurant.position.lat]),
            { name: restaurant.poi ? restaurant.poi.name : 'Restaurant', address: restaurant.address?.freeformAddress, phone: restaurant.phone }
          ));
        }
      });
      map.setCamera({ center: [centerLon, centerLat], zoom: 13 });
      map.events.add('click', datasource, e => {
        if (e.shapes?.[0]?.getProperties()?.type !== 'center') {
          const shape = e.shapes[0];
          popup.setOptions({
            position: e.position,
            content: `<div class="p-2"><h3 class="font-bold">${shape.getProperties().name}</h3>
                     <p class="text-sm">${shape.getProperties().address || ''}</p>
                     ${shape.getProperties().phone ? `<p class="text-sm">${shape.getProperties().phone}</p>` : ''}</div>`,
            pixelOffset: [0, -20]
          });
          popup.open(map);
        }
      });
    }

    function updatePagination() {
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      pagination.classList.remove('hidden');
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    function goToPreviousPage() { if (currentPage > 1) { currentPage--; searchRestaurants(lastSearchTerm, lastLocation, currentPage); } }
    function goToNextPage() { if (currentPage < totalPages) { currentPage++; searchRestaurants(lastSearchTerm, lastLocation, currentPage); } }
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      resultsContainer.innerHTML = '';
      pagination.classList.add('hidden');
      mapContainer.classList.add('hidden');
    }
  </script>
</body>
</html>
